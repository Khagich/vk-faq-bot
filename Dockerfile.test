FROM python:3.11-slim

WORKDIR /app

# Устанавливаем системные зависимости
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Копируем зависимости
COPY requirements.txt requirements-test.txt ./
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir -r requirements-test.txt

# Копируем ВСЕ файлы из текущей директории
COPY . .

# Проверяем что tests/ скопировалась
RUN echo "=== Проверка файлов в /app ===" && \
    ls -la && \
    echo "=== Проверка папки tests/ ===" && \
    if [ -d "tests" ]; then \
        echo "✅ Папка tests/ существует!" && \
        ls -la tests/ && \
        echo "✅ Файлы в tests/:" && \
        find tests/ -name "*.py"; \
    else \
        echo "❌ Папка tests/ не найдена!" && \
        echo "Ищем тестовые файлы:" && \
        find /app -name "*test*.py" -type f; \
    fi

# Запускаем тесты
CMD ["python", "-m", "pytest", "/app/tests/", "-v", "--cov=/app/src", "--junitxml=/app/test-results.xml"]